<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { 
      font-family: 'Poppins', sans-serif; 
      background: #f4f7fa; 
      min-height: 100vh; 
      padding: 20px; 
      overflow-x: hidden; 
    }
    .container { max-width: 1300px; }
    header { 
      background: linear-gradient(135deg, #007bff, #00d4ff); 
      color: white; 
      padding: 30px; 
      border-radius: 15px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
      margin-bottom: 40px; 
    }
    .carousel-inner img { 
      border-radius: 15px; 
      object-fit: cover; 
      height: 350px; 
      transition: transform 0.3s; 
    }
    .carousel-item:hover img { transform: scale(1.02); }
    .section-title { 
      color: #333; 
      font-weight: 600; 
      border-bottom: 3px solid #007bff; 
      display: inline-block; 
      padding-bottom: 8px; 
      margin-bottom: 25px; 
    }
    .selection-grid, .product-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap: 20px; 
      margin-bottom: 40px; 
    }
    .initial-selection { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
      gap: 20px; 
      margin-bottom: 40px; 
    }
    .selection-card, .product-card { 
      background: #fff; 
      border-radius: 15px; 
      overflow: hidden; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
      transition: transform 0.2s, box-shadow 0.2s; 
      cursor: pointer; 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
    }
    .selection-card:hover, .product-card:hover { 
      transform: translateY(-5px); 
      box-shadow: 0 6px 20px rgba(0,0,0,0.1); 
    }
    .selection-card img, .product-card img { 
      width: 100%; 
      height: 200px; 
      object-fit: cover; 
      transition: transform 0.3s; 
    }
    .product-card img { height: 180px; }
    .card-body { 
      padding: 15px; 
      flex-grow: 1; 
      display: flex; 
      flex-direction: column; 
      justify-content: space-between; 
    }
    .card-title { 
      color: #333; 
      font-weight: 600; 
      margin-bottom: 10px; 
    }
    .card-text { color: #666; margin-bottom: 15px; }
    .btn-primary { 
      background: #007bff; 
      border: none; 
      border-radius: 25px; 
      padding: 10px 20px; 
      font-weight: 600; 
      transition: background 0.3s; 
    }
    .btn-primary:hover { background: #0056b3; }
    .btn-success, .btn-danger { 
      border-radius: 25px; 
      padding: 8px 16px; 
      transition: all 0.3s; 
    }
    .form-control { 
      border-radius: 10px; 
      border: 1px solid #ced4da; 
      padding: 10px; 
      transition: border-color 0.3s; 
    }
    .form-control:focus { border-color: #007bff; box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); }
    #cartItems { max-height: 300px; overflow-y: auto; }
    .spinner { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      z-index: 9999; 
      width: 60px; 
      height: 60px; 
      border: 6px solid #f3f3f3; 
      border-top: 6px solid #007bff; 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
    .cart-button { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      z-index: 1000; 
      background: #007bff; 
      border-radius: 50%; 
      width: 60px; 
      height: 60px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
      transition: transform 0.3s; 
    }
    .cart-button:hover { transform: scale(1.1); }
    .cart-button span { color: white; font-size: 14px; font-weight: 600; }
    .stock-info { color: #28a745; font-size: 0.9em; }
    @media (max-width: 768px) { 
      .carousel-inner img { height: 200px; }
      .selection-card img, .product-card img { height: 150px; }
      header { padding: 20px; }
      .initial-selection, .selection-grid, .product-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
      .cart-button { width: 50px; height: 50px; bottom: 15px; right: 15px; }
      .cart-button span { font-size: 12px; }
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <header class="mb-4 text-center">
      <h1 class="display-5 fw-bold">23 ‡∏õ‡∏±‡∏ô‡∏™‡∏∏‡∏Ç</h1>
      <p class="text-light">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà</p>
    </header>

    <div id="spinner" class="spinner" style="display: none;"></div>

    <div id="promoCarousel" class="carousel slide mb-5 shadow-sm" data-bs-ride="carousel" data-bs-interval="5000">
      <div class="carousel-inner" id="promoContent"></div>
      <button class="carousel-control-prev" type="button" data-bs-target="#promoCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#promoCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    </div>

    <h3 class="section-title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏∑‡πâ‡∏≠</h3>
    <div id="initialSelection" class="initial-selection mb-5">
      <div class="selection-card" onclick="showCategories()">
        <img src="https://img5.pic.in.th/file/secure-sv1/select-product.png" alt="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
        <div class="card-body text-center fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
      </div>
      <div class="selection-card" onclick="showStores()">
        <img src="https://img2.pic.in.th/pic/select-store.png" alt="‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">
        <div class="card-body text-center fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</div>
      </div>
    </div>

    <div id="selectionGrid" class="selection-grid" style="display: none;"></div>
    <div id="productGrid" class="product-grid" style="display: none;"></div>

    <!-- Cart Button -->
    <button class="cart-button" onclick="cartModal.show()">
      <span id="cartCount">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (0)</span>
    </button>
  </div>

  <!-- Cart Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background: #007bff; color: white; border-radius: 15px 15px 0 0;">
          <h5 class="modal-title" id="cartModalLabel">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="cartItems"></div>
        <div class="modal-footer d-flex justify-content-between">
          <button class="btn btn-danger" onclick="resetCart()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
          <span id="totalPrice" class="fw-bold"></span>
          <button class="btn btn-primary" onclick="showOrderForm()">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Form Modal -->
  <div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background: #007bff; color: white; border-radius: 15px 15px 0 0;">
          <h5 class="modal-title" id="orderModalLabel">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 text-center">
            <button class="btn btn-success" onclick="loginWithLine()">
              <i class="bi bi-line"></i> ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ LINE
            </button>
            <small class="d-block mt-2 text-muted">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</small>
          </div>
          
          <input id="customerName" class="form-control mb-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠" aria-label="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" required>
          <input id="phone" class="form-control mb-3" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" aria-label="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" required>
          <input id="lineId" class="form-control mb-3" placeholder="LINE ID" aria-label="LINE ID" readonly required>
          
          <div class="input-group mb-3">
            <input id="location" class="form-control" placeholder="‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)" aria-label="‡∏û‡∏¥‡∏Å‡∏±‡∏î" required>
            <button class="btn btn-outline-secondary" onclick="getCustomerLocation()">‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="button" class="btn btn-primary" onclick="submitOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
        </div>
      </div>
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ API URL
  <script>
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ API URL - ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà YOUR_WEB_APP_ID ‡∏î‡πâ‡∏ß‡∏¢ ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const API_URL = 'https://script.google.com/macros/s/AKfycbxMCMktZ587jN20APcBO0MfoEG2M3WBwj4vhkVUjB9VdshGmrB10M0Ty_KKcDaqXm4LcQ/exec';
    
    let cart = [];
    let liffInitialized = false;
    let lineProfile = null;
    const cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
    const orderModal = new bootstrap.Modal(document.getElementById('orderModal'));

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    function showSpinner() { document.getElementById('spinner').style.display = 'block'; }
    function hideSpinner() { document.getElementById('spinner').style.display = 'none'; }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
   async function fetchData(action, data = {}) {
  try {
    const fullUrl = `${API_URL}?action=${encodeURIComponent(action)}`;
    const response = await fetch(fullUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    });

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ response ‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      const text = await response.text();
      throw new Error(`Invalid response: ${text.substring(0, 100)}`);
    }

    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error || 'Request failed');
    }
    
    return result.data;
  } catch (error) {
    console.error('API Error:', error);
    throw new Error(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ${error.message}`);
  }
}

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadInitialData
    async function loadInitialData() {
      showSpinner();
      try {
        const promoData = await fetchData('getPromotions');
        document.getElementById('promoContent').innerHTML = promoData.length > 0 ? 
          promoData.slice(1).map(function(p, idx) {
            var title = p[1] || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠';
            var desc = p[2] || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
            var img = p[3] || 'https://via.placeholder.com/300x150?text=‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
            return '<div class="carousel-item ' + (idx === 0 ? 'active' : '') + '">' +
                   '<img src="' + img + '" class="d-block w-100" alt="' + title + '">' +
                   '<div class="carousel-caption d-none d-md-block">' +
                   '<h5>' + title + '</h5>' +
                   '<p>' + desc + '</p>' +
                   '</div></div>';
          }).join('') : '<div class="carousel-item active"><p class="text-center py-5">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</p></div>';
      } catch (err) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÑ‡∏î‡πâ', 'error');
      } finally {
        hideSpinner();
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    function getCustomerLocation() {
      if (navigator.geolocation) {
        showSpinner();
        navigator.geolocation.getCurrentPosition(
          position => {
            const location = position.coords.latitude + ',' + position.coords.longitude;
            document.getElementById('location').value = location;
            hideSpinner();
          },
          error => {
            Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á', 'warning');
            document.getElementById('location').value = '';
            hideSpinner();
          },
          { timeout: 10000, enableHighAccuracy: true }
        );
      } else {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation', 'error');
        document.getElementById('location').value = '';
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function loadInitialData() {
      showSpinner();
      try {
        const promoData = await fetchData('getPromotions');
        document.getElementById('promoContent').innerHTML = promoData.length > 0 ? 
          promoData.slice(1).map(function(p, idx) {
            var title = p[1] || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠';
            var desc = p[2] || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
            var img = p[3] || 'https://via.placeholder.com/300x150?text=‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
            return '<div class="carousel-item ' + (idx === 0 ? 'active' : '') + '">' +
                   '<img src="' + img + '" class="d-block w-100" alt="' + title + '">' +
                   '<div class="carousel-caption d-none d-md-block">' +
                   '<h5>' + title + '</h5>' +
                   '<p>' + desc + '</p>' +
                   '</div></div>';
          }).join('') : '<div class="carousel-item active"><p class="text-center py-5">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</p></div>';
      } catch (err) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÑ‡∏î‡πâ', 'error');
      } finally {
        hideSpinner();
      }
    }

    async function showCategories() {
      document.getElementById('initialSelection').style.display = 'none';
      document.getElementById('selectionGrid').style.display = 'grid';
      document.getElementById('productGrid').style.display = 'none';
      showSpinner();
      try {
        const categoryData = await fetchData('getCategories');
        document.getElementById('selectionGrid').innerHTML = categoryData.length > 0 ? 
          categoryData.slice(1).map(function(c) {
            var imageUrl = c[2] || 'https://via.placeholder.com/200x200?text=No+Image';
            return '<div class="selection-card" onclick="loadProductsByCategory(\'' + c[0] + '\')">' +
                   '<img src="' + imageUrl + '" alt="' + c[1] + '">' +
                   '<div class="card-body"><h6 class="card-title">' + c[1] + '</h6></div></div>';
          }).join('') : '<p class="text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>';
      } catch (err) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'error');
      } finally {
        hideSpinner();
      }
    }

    async function showStores() {
      document.getElementById('initialSelection').style.display = 'none';
      document.getElementById('selectionGrid').style.display = 'grid';
      document.getElementById('productGrid').style.display = 'none';
      showSpinner();
      try {
        const storeData = await fetchData('getStores');
        document.getElementById('selectionGrid').innerHTML = storeData.length > 0 ? 
          storeData.slice(1).map(function(s) {
            return '<div class="selection-card" onclick="loadProductsByStore(\'' + s[0] + '\')">' +
                   '<img src="' + s[2] + '" alt="' + s[1] + '" onerror="this.src=\'https://via.placeholder.com/200x200?text=Image+Error\'">' +
                   '<div class="card-body"><h6 class="card-title">' + s[1] + '</h6></div></div>';
          }).join('') : '<p class="text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</p>';
      } catch (err) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'error');
      } finally {
        hideSpinner();
      }
    }

    async function loadProductsByCategory(categoryId) {
      document.getElementById('selectionGrid').style.display = 'none';
      document.getElementById('productGrid').style.display = 'grid';
      showSpinner();
      try {
        const productData = await fetchData('getProducts');
        document.getElementById('productGrid').innerHTML = productData.length > 0 ? 
          productData.slice(1).filter(p => p[2] === categoryId).map(p => {
            return `<div class="product-card">
                   <img src="${p[5]}" alt="${p[3]}" onerror="this.src='https://via.placeholder.com/180x180?text=Image+Error'">
                   <div class="card-body">
                   <h5 class="card-title">${p[3]}</h5>
                   <p class="card-text">${p[4]} ‡∏ö‡∏≤‡∏ó</p>
                   <p class="stock-info">‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${p[6]} ‡∏ä‡∏¥‡πâ‡∏ô</p>
                   <div class="input-group">
                   <input type="number" min="1" max="${p[6]}" id="qty_${p[0]}" value="1" class="form-control">
                   <button class="btn btn-success" onclick="addToCart({id:'${p[0]}',storeId:'${p[1]}',name:'${p[3]}',price:${p[4]},stock:${p[6]}}, document.getElementById('qty_${p[0]}').value)">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                   </div></div></div>`;
          }).join('') : '<p class="text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ</p>';
      } catch (err) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'error');
      } finally {
        hideSpinner();
      }
    }

    async function loadProductsByStore(storeId) {
      document.getElementById('selectionGrid').style.display = 'none';
      document.getElementById('productGrid').style.display = 'grid';
      showSpinner();
      try {
        const productData = await fetchData('getProducts');
        document.getElementById('productGrid').innerHTML = productData.length > 0 ? 
          productData.slice(1).filter(p => p[1] === storeId).map(p => {
            return `<div class="product-card">
                   <img src="${p[5]}" alt="${p[3]}" onerror="this.src='https://via.placeholder.com/180x180?text=Image+Error'">
                   <div class="card-body">
                   <h5 class="card-title">${p[3]}</h5>
                   <p class="card-text">${p[4]} ‡∏ö‡∏≤‡∏ó</p>
                   <p class="stock-info">‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${p[6]} ‡∏ä‡∏¥‡πâ‡∏ô</p>
                   <div class="input-group">
                   <input type="number" min="1" max="${p[6]}" id="qty_${p[0]}" value="1" class="form-control">
                   <button class="btn btn-success" onclick="addToCart({id:'${p[0]}',storeId:'${p[1]}',name:'${p[3]}',price:${p[4]},stock:${p[6]}}, document.getElementById('qty_${p[0]}').value)">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                   </div></div></div>`;
          }).join('') : '<p class="text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</p>';
      } catch (err) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'error');
      } finally {
        hideSpinner();
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    function addToCart(item, qty) {
      qty = parseInt(qty);
      if (qty < 1 || qty > item.stock) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-${item.stock}`, 'error');
        return;
      }
      if (cart.length >= 10 && !cart.find(i => i.id === item.id)) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏° (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)', 'error');
        return;
      }
      if (cart.length > 0 && cart[0].storeId !== item.storeId) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
        return;
      }

      var existingItem = cart.find(i => i.id === item.id);
      if (existingItem) {
        existingItem.qty += qty;
        if (existingItem.qty > item.stock) {
          Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${item.name}" ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${item.stock}`, 'error');
          existingItem.qty = item.stock;
        }
      } else {
        cart.push({ id: item.id, storeId: item.storeId, name: item.name, price: item.price, qty: qty });
      }
      updateCart();
      cartModal.show();
    }

    function updateCart() {
      var cartDiv = document.getElementById('cartItems');
      cartDiv.innerHTML = cart.length > 0 ? cart.map((item, idx) => {
        return '<div class="d-flex justify-content-between align-items-center mb-2">' +
               '<span>' + item.name + ' - ' + item.price + ' x ' + item.qty + '</span>' +
               '<button class="btn btn-sm btn-danger" onclick="removeFromCart(' + idx + ')">üóëÔ∏è</button>' +
               '</div>';
      }).join('') : '<p class="text-center">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>';
      var total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
      document.getElementById('totalPrice').innerText = '‡∏£‡∏ß‡∏°: ' + total + ' ‡∏ö‡∏≤‡∏ó';
      document.getElementById('cartCount').innerText = `‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (${cart.length})`;
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCart();
    }

    function resetCart() {
      cart = [];
      updateCart();
    }

    function showOrderForm() {
      if (cart.length === 0) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', 'error');
        return;
      }
      cartModal.hide();
      orderModal.show();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    async function submitOrder() {
      var orderData = {
        customerName: document.getElementById('customerName').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        lineId: document.getElementById('lineId').value.trim(),
        location: document.getElementById('location').value.trim(),
        items: cart
      };
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      if (!orderData.customerName || !orderData.phone || !orderData.lineId || !orderData.location) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');
        return;
      }
      
      showSpinner();
      try {
        const orderId = await fetchData('saveOrder', {orderData});
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ #' + orderId + ' ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        resetCart();
        // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
        document.getElementById('customerName').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('lineId').value = '';
        document.getElementById('location').value = '';
        orderModal.hide();
      } catch (err) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ', 'error');
      } finally {
        hideSpinner();
      }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô
    window.onload = function() {
      loadInitialData();
      getCustomerLocation();
    };
  </script>
</body>
</html>
